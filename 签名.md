# Web3 SIWE ç­¾åè®¤è¯å®Œæ•´æŒ‡å—

> åŸºäº EIP-4361ï¼ˆSign-In with Ethereumï¼‰æ ‡å‡†çš„ä¼šè¯ç®¡ç†ç³»ç»Ÿ  
> å®ç°ï¼šSIWE ç­¾åä¸€æ¬¡ â†’ è·å¾—ä¼šè¯ä»¤ç‰Œ â†’ 5åˆ†é’Ÿå†…å¤šæ¬¡æ“ä½œæ— éœ€é‡å¤ç­¾å

---

## ğŸ“‹ ç›®å½•

1. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
2. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
3. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
4. [å®Œæ•´æµç¨‹](#å®Œæ•´æµç¨‹)
5. [å‰ç«¯å®ç°](#å‰ç«¯å®ç°)
6. [åç«¯å®ç°](#åç«¯å®ç°)
7. [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
8. [ç”Ÿäº§ç¯å¢ƒå»ºè®®](#ç”Ÿäº§ç¯å¢ƒå»ºè®®)

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### å‰ç«¯ä¾èµ–
- `wagmi@2.19.3` - Web3 é’±åŒ…è¿æ¥
- `siwe@2.3.1` - EIP-4361 æ¶ˆæ¯æ ‡å‡†åº“
- `viem@2.38.0` - Ethereum JSON-RPC å®¢æˆ·ç«¯

### åç«¯ä¾èµ–
- `NestJS@10.4.7` - æœåŠ¡æ¡†æ¶
- `siwe@2.3.1` - SIWE æ¶ˆæ¯éªŒè¯
- `Prisma@6.2.0` - æ•°æ®åº“ ORM

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### è®¤è¯æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯    â”‚              â”‚ åç«¯    â”‚              â”‚ é’±åŒ…    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                        â”‚                       â”‚
     â”‚ 1. GET /nonce          â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
     â”‚ { nonce: "32ä½hex" }   â”‚                       â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
     â”‚                        â”‚                       â”‚
     â”‚ 2. æ„é€  SIWE Message    â”‚                       â”‚
     â”‚ (domain, uri, version, â”‚                       â”‚
     â”‚  chainId, nonce,       â”‚                       â”‚
     â”‚  issuedAt, expirationTime) â”‚                   â”‚
     â”‚                        â”‚                       â”‚
     â”‚ 3. è¯·æ±‚é’±åŒ…ç­¾å         â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚         ç­¾å(SIWE Message)                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                        â”‚                       â”‚
     â”‚ 4. POST /auth          â”‚                       â”‚
     â”‚ (address/message/signature) â”‚                  â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
     â”‚                        â”‚ 5. SIWE verify()      â”‚
     â”‚                        â”‚ - æ£€æŸ¥ç­¾åæœ‰æ•ˆæ€§      â”‚
     â”‚                        â”‚ - æ£€æŸ¥åœ°å€åŒ¹é…        â”‚
     â”‚                        â”‚ - æ£€æŸ¥ nonce/expiry  â”‚
     â”‚ { token, expiresIn }   â”‚                       â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
     â”‚                        â”‚                       â”‚
     â”‚ 6. å­˜å‚¨åˆ° localStorage  â”‚                       â”‚
     â”‚                        â”‚                       â”‚
     â”‚ 7. POST /profile       â”‚                       â”‚
     â”‚ (Bearer token)         â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
     â”‚                        â”‚ 8. éªŒè¯ä¼šè¯           â”‚
     â”‚                        â”‚ - æ£€æŸ¥ token æœ‰æ•ˆæ€§   â”‚
     â”‚ { profile }            â”‚ - æ£€æŸ¥åœ°å€åŒ¹é…        â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
```

---

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µ

### 1. **Nonceï¼ˆä¸€æ¬¡æ€§éšæœºæ•°ï¼‰**
- **ä½œç”¨**: é˜²æ­¢ç­¾åé‡æ”¾æ”»å‡»
- **ç”Ÿå‘½å‘¨æœŸ**: ç”Ÿæˆå 5 åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œä½¿ç”¨åç«‹å³åˆ é™¤
- **æ ¼å¼**: 32 ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆ`randomBytes(16).toString('hex')`ï¼‰
  - âœ… ç¤ºä¾‹ï¼š`a1b2c3d4e5f6789012345678abcdef12`
  - âŒ é”™è¯¯ï¼šUUID æ ¼å¼ `8f7a3b2c-4d5e-...` åŒ…å« `-` ä¼šè¢« SIWE æ‹’ç»

### 2. **SIWE Messageï¼ˆæ ‡å‡†åŒ–ç­¾åæ¶ˆæ¯ï¼‰**
- **ä½œç”¨**: æŒ‰ç…§ EIP-4361 æ ‡å‡†ç”Ÿæˆç”¨æˆ·ç­¾åçš„æ¶ˆæ¯
- **åŒ…å«ä¿¡æ¯**:
  ```
  web3university.com wants you to sign in with your Ethereum account:
  0x1234567890abcdef1234567890abcdef12345678

  Sign in to Web3 University

  URI: https://localhost:3000
  Version: 1
  Chain ID: 1
  Nonce: a1b2c3d4e5f6789012345678abcdef12
  Issued At: 2025-12-26T12:00:00.000Z
  Expiration Time: 2025-12-26T12:05:00.000Z
  ```

### 3. **Session Tokenï¼ˆä¼šè¯ä»¤ç‰Œï¼‰**
- **ä½œç”¨**: ç­¾åé€šè¿‡åé¢å‘çš„çŸ­æœŸæˆæƒå‡­è¯
- **æœ‰æ•ˆæœŸ**: 5 åˆ†é’Ÿï¼ˆ300 ç§’ï¼‰
- **æ ¼å¼**: 32 ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²
- **å­˜å‚¨**:
  - å‰ç«¯ï¼š`localStorage['session_${address}'] = { token, expiryTime }`
  - åç«¯ï¼š`Map<token, SessionData>` æˆ– Redis

---

## ğŸ”„ å®Œæ•´æµç¨‹

### é˜¶æ®µ 1ï¼šåˆæ¬¡è®¤è¯ï¼ˆéœ€è¦ç­¾åï¼‰

```typescript
// 1. ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"
handleSave() â†’ æ£€æŸ¥ä¼šè¯ â†’ æ— æœ‰æ•ˆä¼šè¯

// 2. è·å– nonceï¼ˆalphanumericï¼‰
GET /profile/nonce?address=0x... 
Response: { nonce: "a1b2c3d4e5f6789012345678abcdef12" }

// 3. ä½¿ç”¨ SIWE æ ‡å‡†æ„é€ æ¶ˆæ¯
const siweMessage = new SiweMessage({
  domain: "localhost:3000",
  address: "0x...",
  statement: "Sign in to Web3 University",
  uri: "https://localhost:3000",
  version: "1",
  chainId: 1,
  nonce: "a1b2c3d4e5f6789012345678abcdef12",
  issuedAt: "2025-12-26T12:00:00Z",
  expirationTime: "2025-12-26T12:05:00Z"
});
const message = siweMessage.prepareMessage();

// 4. è¯·æ±‚é’±åŒ…ç­¾åï¼ˆMetaMask å¼¹çª—æ˜¾ç¤ºæ ‡å‡†æ ¼å¼ï¼‰
signature = await signMessageAsync({ address, message })

// 5. æäº¤ç­¾ååˆ°åç«¯éªŒè¯ï¼ˆSIWE verifyï¼‰
POST /profile/auth
Body: { address, signature, message }
Response: { token: "hexadecimal32chars", expiresIn: 300 }

// 6. å­˜å‚¨ä¼šè¯ä»¤ç‰Œåˆ° localStorage
localStorage.setItem('session_0x...', JSON.stringify({
  token: "hexadecimal32chars",
  expiryTime: Date.now() + 300000
}))

// 7. ä½¿ç”¨ä¼šè¯ä»¤ç‰Œä¿å­˜èµ„æ–™
POST /profile
Headers: { Authorization: "Bearer hexadecimal32chars" }
Body: { address, profile: {...} }
```

### é˜¶æ®µ 2ï¼šåç»­æ“ä½œï¼ˆ5åˆ†é’Ÿå†…æ— éœ€ç­¾åï¼‰

```typescript
// 1. ç”¨æˆ·å†æ¬¡ç‚¹å‡»"ä¿å­˜"
handleSave() â†’ æ£€æŸ¥ä¼šè¯ â†’ å‘ç°æœ‰æ•ˆä¼šè¯

// 2. ä» localStorage è¯»å–ä»¤ç‰Œ
const saved = localStorage.getItem('session_0x...')
const { token, expiryTime } = JSON.parse(saved)

// 3. ç›´æ¥ä½¿ç”¨ä»¤ç‰Œä¿å­˜ï¼ˆæ— ç­¾åå¼¹çª—ï¼‰
POST /profile
Headers: { Authorization: "Bearer <token>" }
Body: { address, profile: {...} }
Response: { ...profile }
```

### é˜¶æ®µ 3ï¼šä¼šè¯è¿‡æœŸï¼ˆè‡ªåŠ¨é‡æ–°è®¤è¯ï¼‰

```typescript
// 1. ä»¤ç‰Œè¿‡æœŸæˆ–æ— æ•ˆï¼Œåç«¯è¿”å› 401
POST /profile â†’ 401 Unauthorized

// 2. å‰ç«¯æ£€æµ‹åˆ° 401ï¼Œè‡ªåŠ¨æ¸…é™¤æœ¬åœ°ä¼šè¯
clearSession() â†’ localStorage.removeItem('session_0x...')

// 3. è‡ªåŠ¨é‡æ–°å‘èµ·ç­¾åæµç¨‹ï¼ˆå›åˆ°é˜¶æ®µ1ï¼‰
authenticateAndSave() â†’ ç”¨æˆ·é‡æ–°ç­¾å â†’ è·å¾—æ–°ä¼šè¯
```

---

## ğŸ’» å‰ç«¯å®ç°ï¼ˆSIWE æ ‡å‡†ï¼‰

### å®‰è£…ä¾èµ–

```bash
pnpm add siwe@2.3.1
```

### æ ¸å¿ƒä»£ç ï¼ˆReact + Wagmi + SIWEï¼‰

```typescript
'use client';
import { useState, useEffect } from 'react';
import { useAccount, useSignMessage, usePublicClient } from 'wagmi';
import { SiweMessage } from 'siwe';

const BACKEND_URL = process.env.NEXT_PUBLIC_API_URL;

export default function ProfilePage() {
  const publicClient = usePublicClient();
  const { address, isConnected } = useAccount();
  const { signMessageAsync } = useSignMessage();
  
  const [sessionToken, setSessionToken] = useState<string | null>(null);
  const [sessionExpiry, setSessionExpiry] = useState<number | null>(null);

  // ========== ä¼šè¯ç®¡ç† ==========
  
  const isSessionValid = () => {
    if (!sessionToken || !sessionExpiry) return false;
    return Date.now() < sessionExpiry;
  };

  const saveSession = (token: string, expiryTime: number) => {
    setSessionToken(token);
    setSessionExpiry(expiryTime);
    if (address) {
      localStorage.setItem(`session_${address}`, JSON.stringify({
        token,
        expiryTime,
      }));
    }
  };

  const clearSession = () => {
    setSessionToken(null);
    setSessionExpiry(null);
    if (address) {
      localStorage.removeItem(`session_${address}`);
    }
  };

  useEffect(() => {
    if (!address) return;
    
    const saved = localStorage.getItem(`session_${address}`);
    if (saved) {
      try {
        const { token, expiryTime } = JSON.parse(saved);
        if (Date.now() < expiryTime) {
          setSessionToken(token);
          setSessionExpiry(expiryTime);
        } else {
          localStorage.removeItem(`session_${address}`);
        }
      } catch (err) {
        localStorage.removeItem(`session_${address}`);
      }
    }
  }, [address]);

  // ========== SIWE ç­¾åè®¤è¯ ==========
  
  const authenticateAndSave = async () => {
    if (!address) throw new Error('Missing address');

    // 1. è·å– nonce
    const nonceRes = await fetch(`${BACKEND_URL}/profile/nonce?address=${address}`);
    const { nonce } = await nonceRes.json();

    // 2. æ„é€  SIWE æ¶ˆæ¯ï¼ˆEIP-4361 æ ‡å‡†ï¼‰
    const chainId = await publicClient?.getChainId();
    const issuedAt = new Date();
    const expirationTime = new Date(issuedAt.getTime() + 5 * 60 * 1000).toISOString();

    const siweMessage = new SiweMessage({
      domain: window.location.host,
      address: address as `0x${string}`,
      statement: 'Sign in to Web3 University',
      uri: window.location.origin,
      version: '1',
      chainId: chainId ?? 1,
      nonce,  // â­ alphanumericï¼Œæ— ç‰¹æ®Šå­—ç¬¦
      issuedAt: issuedAt.toISOString(),
      expirationTime,
    });

    const message = siweMessage.prepareMessage();

    // 3. è¯·æ±‚ç”¨æˆ·ç­¾å
    const signature = await signMessageAsync({ account: address, message });

    // 4. æäº¤ç­¾åè·å–ä¼šè¯ä»¤ç‰Œ
    const authRes = await fetch(`${BACKEND_URL}/profile/auth`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ address, signature, message }),
    });

    if (!authRes.ok) throw new Error('Authentication failed');

    const { token, expiresIn } = await authRes.json();
    
    // 5. ä¿å­˜ä¼šè¯å¹¶ç»§ç»­æ“ä½œ
    saveSession(token, Date.now() + expiresIn * 1000);
    await saveProfileWithToken(token);
  };

  // ========== ä¿å­˜èµ„æ–™ ==========
  
  const saveProfileWithToken = async (token: string): Promise<boolean> => {
    const res = await fetch(`${BACKEND_URL}/profile`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify({ address, profile: formData }),
    });

    if (res.status === 401) {
      clearSession();
      return false;
    }

    if (!res.ok) throw new Error('Failed to save profile');
    
    const updated = await res.json();
    setProfile(updated);
    return true;
  };

  const handleSave = async () => {
    try {
      if (isSessionValid()) {
        const success = await saveProfileWithToken(sessionToken!);
        if (!success) await authenticateAndSave();
      } else {
        await authenticateAndSave();
      }
      alert('âœ… Profile updated!');
    } catch (err) {
      alert(`âŒ ${err.message}`);
    }
  };

  return (
    // JSX ç»„ä»¶å†…å®¹
  );
}
```

---

## ğŸ”§ åç«¯å®ç°

### å®‰è£…ä¾èµ–

```bash
pnpm add siwe@2.3.1
```

### Controller - 3 ä¸ªæ ¸å¿ƒç«¯ç‚¹

```typescript
import { Body, Controller, Get, Post, Query, Headers, BadRequestException, UnauthorizedException } from '@nestjs/common';
import { SiweMessage } from 'siwe';
import { randomBytes } from 'crypto';

interface SessionData {
  address: string;
  createdAt: number;
  expiresAt: number;
}

@Controller()
export class ProfileController {
  private nonceStore = new Map<string, { nonce: string; createdAt: number }>();
  private sessionStore = new Map<string, SessionData>();

  // ========== 1. è·å– nonceï¼ˆalphanumericï¼‰ ==========
  @Get('/profile/nonce')
  async getNonce(@Query('address') address?: string): Promise<{ nonce: string }> {
    if (!address || !/^0x[a-fA-F0-9]{40}$/i.test(address)) {
      throw new BadRequestException('Invalid address');
    }

    // â­ ç”Ÿæˆ SIWE å…¼å®¹çš„ nonceï¼ˆæ— ç‰¹æ®Šå­—ç¬¦ï¼‰
    const nonce = randomBytes(16).toString('hex');

    this.nonceStore.set(address.toLowerCase(), {
      nonce,
      createdAt: Date.now(),
    });

    return { nonce };
  }

  // ========== 2. SIWE éªŒè¯ä¸ä¼šè¯å‘æ”¾ ==========
  @Post('/profile/auth')
  async authenticate(
    @Body() body: { address: string; signature: string; message: string }
  ): Promise<{ token: string; expiresIn: number }> {
    const { address, signature, message } = body;

    if (!address || !signature || !message) {
      throw new BadRequestException('Missing required fields');
    }

    // éªŒè¯ nonce å­˜åœ¨
    const stored = this.nonceStore.get(address.toLowerCase());
    if (!stored) {
      throw new UnauthorizedException('Invalid or expired nonce');
    }

    // â­ SIWE æ ‡å‡†éªŒè¯
    try {
      const siweMessage = new SiweMessage(message);

      // åœ°å€åŒ¹é…
      if (siweMessage.address.toLowerCase() !== address.toLowerCase()) {
        throw new UnauthorizedException('Address mismatch');
      }

      // nonce åŒ¹é…
      if (siweMessage.nonce !== stored.nonce) {
        throw new UnauthorizedException('Invalid or expired nonce');
      }

      // éªŒè¯ç­¾åå’Œæœ‰æ•ˆæœŸ
      const verification = await siweMessage.verify({
        signature,
        nonce: stored.nonce,
        time: new Date().toISOString(),
      });

      if (!verification.success) {
        throw new UnauthorizedException('Signature verification failed');
      }
    } catch (error) {
      if (error instanceof UnauthorizedException) throw error;
      throw new UnauthorizedException('Invalid SIWE message or signature');
    }

    // Nonce ä½¿ç”¨ååˆ é™¤ï¼ˆé˜²é‡æ”¾ï¼‰
    this.nonceStore.delete(address.toLowerCase());

    // ========== é¢å‘ä¼šè¯ä»¤ç‰Œ ==========
    const now = Date.now();
    const sessionToken = randomBytes(16).toString('hex');
    const expiresAt = now + 5 * 60 * 1000;

    this.sessionStore.set(sessionToken, {
      address: address.toLowerCase(),
      createdAt: now,
      expiresAt,
    });

    return {
      token: sessionToken,
      expiresIn: 5 * 60,
    };
  }

  // ========== 3. ä¼šè¯ä»¤ç‰Œè®¤è¯ï¼ˆæ— éœ€é‡å¤ç­¾åï¼‰ ==========
  @Post('/profile')
  async updateProfile(
    @Headers('authorization') authHeader: string | undefined,
    @Body() body: { address: string; profile: any }
  ) {
    const { address, profile } = body;

    if (!address || !profile) {
      throw new BadRequestException('Invalid payload');
    }

    // æå– Bearer token
    const token = authHeader?.replace('Bearer ', '');

    // éªŒè¯ä¼šè¯
    if (!this.verifySession(token, address)) {
      throw new UnauthorizedException('Invalid or expired session');
    }

    // ä¼šè¯æœ‰æ•ˆï¼Œæ›´æ–°èµ„æ–™ï¼ˆæ— éœ€ç­¾åï¼‰
    return this.service.saveProfile(address, profile);
  }

  // ========== å·¥å…·æ–¹æ³• ==========
  
  private verifySession(token: string | undefined, address: string): boolean {
    if (!token) return false;
    
    const session = this.sessionStore.get(token);
    if (!session) return false;
    
    // æ£€æŸ¥è¿‡æœŸ
    if (Date.now() > session.expiresAt) {
      this.sessionStore.delete(token);
      return false;
    }
    
    // æ£€æŸ¥åœ°å€åŒ¹é…
    return session.address.toLowerCase() === address.toLowerCase();
  }

  // ========== è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ® ==========
  onModuleInit() {
    setInterval(() => {
      const now = Date.now();

      // æ¸…ç†è¿‡æœŸ nonce
      for (const [address, { createdAt }] of this.nonceStore) {
        if (now - createdAt > 5 * 60 * 1000) {
          this.nonceStore.delete(address);
        }
      }

      // æ¸…ç†è¿‡æœŸä¼šè¯
      for (const [token, { expiresAt }] of this.sessionStore) {
        if (now > expiresAt) {
          this.sessionStore.delete(token);
        }
      }
    }, 60 * 1000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  }
}
```

---

## ğŸ” å®‰å…¨æœºåˆ¶

### 1. é˜²é‡æ”¾æ”»å‡»

| æœºåˆ¶ | å®ç° |
|------|------|
| **Nonce** | ä½¿ç”¨åç«‹å³åˆ é™¤ï¼Œæ— æ³•é‡ç”¨ |
| **Expiration Time** | SIWE æ¶ˆæ¯åŒ…å«è¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨æ ¡éªŒ |
| **åœ°å€ç»‘å®š** | ç­¾åæ¶ˆæ¯åŒ…å«ç”¨æˆ·åœ°å€ï¼Œé˜²æ­¢è·¨åœ°å€ä½¿ç”¨ |
| **ä¼šè¯ä»¤ç‰Œ** | åç«¯ç»‘å®šåˆ°ç‰¹å®šåœ°å€ï¼Œæ— æ³•è·¨è´¦æˆ·ä½¿ç”¨ |

### 2. æ—¶é—´æœ‰æ•ˆæœŸ

```typescript
// ç­¾åæ¶ˆæ¯ç¤ºä¾‹
SIWE æ¶ˆæ¯ï¼š
  Issued At: 2025-12-26T12:00:00Z
  Expiration Time: 2025-12-26T12:05:00Z  â† 5 åˆ†é’Ÿè¿‡æœŸ

ä¼šè¯ä»¤ç‰Œï¼š
  expiresAt = now + 5 * 60 * 1000  â† 5 åˆ†é’Ÿæœ‰æ•ˆæœŸ
```

### 3. é˜²é’“é±¼

- é’±åŒ…æ˜¾ç¤ºæ¸…æ™°çš„ SIWE æ¶ˆæ¯æ ¼å¼
- ç”¨æˆ·å¯è§ `domain`ï¼ˆå½“å‰ç½‘ç«™ï¼‰
- ç”¨æˆ·å¯è§ `uri`ï¼ˆæ¥æº URLï¼‰
- ç”¨æˆ·å¯è§ `statement`ï¼ˆæ“ä½œè¯´æ˜ï¼‰

---

## ğŸš€ ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. ä½¿ç”¨ Redis æ›¿ä»£å†…å­˜å­˜å‚¨

```typescript
import Redis from 'ioredis';

const redis = new Redis();

// å­˜å‚¨ nonceï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
await redis.setex(`nonce:${address}`, 300, nonce);

// å­˜å‚¨ä¼šè¯ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
await redis.setex(`session:${token}`, 300, JSON.stringify({
  address,
  createdAt: Date.now(),
}));
```

### 2. å¢åŠ é€Ÿç‡é™åˆ¶

```bash
pnpm add @nestjs/throttler
```

```typescript
// app.module.ts
import { ThrottlerModule } from '@nestjs/throttler';

@Module({
  imports: [
    ThrottlerModule.forRoot({
      ttl: 60,
      limit: 5, // æ¯åˆ†é’Ÿæœ€å¤š 5 æ¬¡
    }),
  ],
})
export class AppModule {}
```

### 3. CORS å®‰å…¨é…ç½®

```typescript
// main.ts
app.enableCors({
  origin: ['https://web3university.com'],
  credentials: true,
  allowedHeaders: ['Content-Type', 'Authorization'],
  methods: ['GET', 'POST', 'OPTIONS'],
});
```

### 4. æ—¥å¿—å®¡è®¡

```typescript
@Post('/profile/auth')
async authenticate(
  @Body() body: { address: string; signature: string; message: string },
  @Ip() ip: string
): Promise<{ token: string; expiresIn: number }> {
  try {
    // ... éªŒè¯é€»è¾‘
    
    this.logger.log({
      event: 'AUTH_SUCCESS',
      address: body.address,
      ip,
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    this.logger.warn({
      event: 'AUTH_FAILED',
      address: body.address,
      ip,
      reason: error.message,
      timestamp: new Date().toISOString(),
    });
    throw error;
  }
}
```

---

## ğŸ“Š æµ‹è¯•æµç¨‹

### ä½¿ç”¨ curl æµ‹è¯•

```bash
# 1. è·å– nonceï¼ˆalphanumericï¼‰
curl "http://localhost:3000/profile/nonce?address=0x1234567890abcdef1234567890abcdef12345678"
# Response: {"nonce":"a1b2c3d4e5f6789012345678abcdef12"}

# 2. å‰ç«¯æ„é€  SIWE æ¶ˆæ¯å¹¶ç­¾å
# ç”¨æˆ·åœ¨é’±åŒ…ä¸­çœ‹åˆ°æ ‡å‡†æ ¼å¼çš„ SIWE æ¶ˆæ¯

# 3. æäº¤ç­¾åè·å–ä¼šè¯ä»¤ç‰Œ
curl -X POST http://localhost:3000/profile/auth \
  -H "Content-Type: application/json" \
  -d '{
    "address": "0x1234567890abcdef1234567890abcdef12345678",
    "signature": "0xabc123...",
    "message": "web3university.com wants you to sign in...\n\nNonce: a1b2c3d4e5f6789012345678abcdef12\n..."
  }'
# Response: {"token":"a1b2c3d4e5f6789012345678abcdef12","expiresIn":300}

# 4. ä½¿ç”¨ä¼šè¯ä»¤ç‰Œæ›´æ–°èµ„æ–™ï¼ˆ5åˆ†é’Ÿå†…æ— éœ€é‡æ–°ç­¾åï¼‰
curl -X POST http://localhost:3000/profile \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer a1b2c3d4e5f6789012345678abcdef12" \
  -d '{
    "address": "0x1234567890abcdef1234567890abcdef12345678",
    "profile": {
      "name": "Alice",
      "email": "alice@example.com",
      "bio": "Web3 Developer"
    }
  }'
# Response: {"name":"Alice","email":"alice@example.com",...}
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ nonce å¿…é¡»æ˜¯ alphanumericï¼Ÿ

**A**: SIWE æ ‡å‡†ï¼ˆEIP-4361ï¼‰è§„å®š nonce å¿…é¡»æ»¡è¶³ï¼š
- é•¿åº¦ > 8 ä¸ªå­—ç¬¦
- ä»…åŒ…å«å­—æ¯å’Œæ•°å­—ï¼ˆæ— ç‰¹æ®Šå­—ç¬¦å¦‚ `-`ï¼‰

è¿™æ˜¯ä¸ºäº†ç¡®ä¿é’±åŒ…æ˜¾ç¤ºçš„æ¶ˆæ¯æ ¼å¼ç»Ÿä¸€ä¸”æ˜“è¯»ã€‚

### Q2: èƒ½ç”¨ UUID æ ¼å¼çš„ nonce å—ï¼Ÿ

**A**: ä¸èƒ½ã€‚UUID æ ¼å¼ `8f7a3b2c-4d5e-...` åŒ…å« `-` ä¼šè¢« SIWE æ‹’ç»ï¼ŒæŠ¥é”™ï¼š
```
Nonce size smaller then 8 characters or is not alphanumeric.
```

ä½¿ç”¨ `randomBytes(16).toString('hex')` ç”Ÿæˆ 32 ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²æ›¿ä»£ã€‚

### Q3: localStorage å­˜å‚¨ä¼šè¯å®‰å…¨å—ï¼Ÿ

**A**: å®‰å…¨ï¼Œå› ä¸ºï¼š
1. Token åªæ˜¯ 32 ä½åå…­è¿›åˆ¶æ•°ï¼Œæ— æ•æ„Ÿä¿¡æ¯
2. åç«¯éªŒè¯æ—¶ç»‘å®šåœ°å€ï¼Œæ— æ³•è·¨è´¦æˆ·ä½¿ç”¨
3. 5 åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ
4. XSS æ”»å‡»å¯è·å–ä»¤ç‰Œï¼Œä½†æ— æ³•è½¬ç§»èµ„äº§ï¼ˆåç«¯æ ¡éªŒåœ°å€ï¼‰

### Q4: ä¸ºä»€ä¹ˆä½¿ç”¨ä¼šè¯ä»¤ç‰Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½ç­¾åï¼Ÿ

**A**: ç”¨æˆ·ä½“éªŒã€‚æ¯æ¬¡æ“ä½œéƒ½å¼¹é’±åŒ…ä¼šå¾ˆçƒ¦äººã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼šä¿å­˜èµ„æ–™ â†’ ç­¾å â†’ ä¿®æ”¹èµ„æ–™ â†’ å†ç­¾å â†’ å†ä¿®æ”¹ â†’ åˆç­¾å...
ä¼šè¯æ–¹å¼ï¼šé¦–æ¬¡ç­¾å â†’ 5åˆ†é’Ÿå†…éšæ„æ“ä½œï¼ˆæ— å¼¹çª—ï¼‰â†’ è¿‡æœŸåé‡æ–°ç­¾å
```

### Q5: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ç”¨ Redis å—ï¼Ÿ

**A**: å¼ºçƒˆæ¨èï¼š
- å•æœºå†…å­˜å­˜å‚¨ï¼šæœåŠ¡é‡å¯åä¼šè¯å…¨éƒ¨ä¸¢å¤±
- å¤šå®ä¾‹éƒ¨ç½²ï¼šä¸åŒå®ä¾‹é—´æ— æ³•å…±äº«ä¼šè¯
- Redisï¼šæŒä¹…åŒ–ã€åˆ†å¸ƒå¼ã€é«˜æ€§èƒ½

---

## ğŸ“š å‚è€ƒèµ„æº

- [EIP-4361: Sign-In with Ethereum](https://eips.ethereum.org/EIPS/eip-4361)
- [SIWE Library](https://github.com/spruceid/siwe)
- [Wagmi useSignMessage](https://wagmi.sh/react/hooks/useSignMessage)
- [Viem recoverMessageAddress](https://viem.sh/docs/actions/public/recoverMessageAddress)

---

**æœ€åæ›´æ–°**: 2025-12-26  
**çŠ¶æ€**: âœ… ç”Ÿäº§å¯ç”¨ï¼ˆå»ºè®®é…åˆ Redis + HTTPSï¼‰
