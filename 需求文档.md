## Web3 大学 DApp 开发计划

> 目标：为课程作者与学习者提供去中心化课程发布、销售、购买、收益管理与用户签名认证体验，涵盖代币经济与 DeFi 理财闭环。

### 0. 系统架构总览

```
┌─────────────────────── 前端 Web3 大学 ───────────────────────┐
│                                                                │
├─── 后期维护 ──────┐  ├─── 用户管理模块 ──────┐                 │
│  ✓ 性能统计      │  │  ✓ MetaMask 钱包连接  │                 │
│  ✓ 纯上用户锚点  │  │  ✓ WalletConnect 集成 │                 │
│  ✓ 合约维护      │  │  ✓ 数据库 + 认证      │                 │
│  ✓ 前端业务更新  │  └────────────────────────┘                 │
└──────────────────┘                                             │
         ▼                          ▼                              │
  ┌─────────────────────── 核心功能模块 ──────────────────────┐  │
  │  ✓ 合约模块 (ERC20 + Market + Aave Router)                │  │
  │  ✓ 知识库 (课程列表、推广)                                │  │
  │  ✓ NFT & 激励 (学习证书、LENS 奖励)                      │  │
  │  ✓ DAO 治理 (投票、决策)                                  │  │
  │  ✓ 视频课程 (外部资源整合)                                │  │
  │  ✓ 学习方式 + 招聘入口                                    │  │
  └──────────────────────────────────────────────────────────┘  │
                                                                 │
└─────────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────── 后端 + 区块链 ────────────────────┐
│                                                       │
├─ 智能合约层 ──────────────────────────────────────┐  │
│  ✓ LENS ERC20 代币                                │  │
│  ✓ 课程市场合约 (创建/购买/授权)                  │  │
│  ✓ 收益路由器 (LENS->ETH->USDT->Aave)            │  │
│  ✓ NFT/证书合约                                  │  │
│  ✓ DAO/投票合约                                  │  │
└──────────────────────────────────────────────────┘  │
│                                                       │
├─ 后端服务 ────────────────────────────────────────┐  │
│  ✓ Nest.js API（用户、课程、交易）                │  │
│  ✓ 数据库 (PostgreSQL/MongoDB)                     │  │
│  ✓ 签名验证 (EIP-191/712)                          │  │
│  ✓ 元数据服务 (IPFS/Pinata)                        │  │
│  ✓ 区块链索引 (The Graph/自建)                     │  │
└──────────────────────────────────────────────────┘  │
│                                                       │
├─ 部署基础设施 ──────────────────────────────────┐  │
│  ✓ AWS/CF 部署                                   │  │
│  ✓ SAM (Serverless Application Model)            │  │
│  ✓ Sepolia 测试网 + 主网就绪                      │  │
└──────────────────────────────────────────────────┘  │
│                                                       │
└───────────────────────────────────────────────────┘
```

### 1. 范围与角色
- 角色：合约开发者、课程作者、学员、平台（合约/前端/后端辅助服务）。
- 代币：平台原生 LENS 代币 (ERC20)，用于课程定价、购买、收益结算、治理投票、学习激励。
- 界面语言：全站 UI 与文案统一使用英文。
- 附加资产：NFT（学习证书）、aUSDT（Aave 质押收益）。
- 网络与依赖：
  - 区块链：Sepolia 测试网（学习测试），主网就绪。
  - 钱包：MetaMask（主要），WalletConnect（备选）。
  - DeFi：Aave v3 USDT 资产池（参考 https://aave.com/docs/resources/addresses）。
  - 文件存储：IPFS/Pinata（课程资源与元数据）。
  - 后端基础设施：AWS/Cloudflare 部署，Nest.js API，PostgreSQL 数据库。
  - 仓库布局：前端、后端、合约统一在 web3-university 仓库中管理（monorepo）。
  - UI 风格：界面与文案统一英文，风格简洁、优美、炫酷（Tailwind + RainbowKit 主题）。

### 2. 合约设计
1) LENS ERC20 代币合约
- 标准：ERC20，支持 mint/burn、permit（EIP-2612）便于授权。
- 角色控制：Owner/Platform 可增发、销毁；支持代币转账与批准。
- 激励机制：平台可分配 LENS 奖励给学习者与讲师。

2) 课程市场合约
- 创建课程：讲师创建课程、设置价格（以 LENS 计价）、元数据 IPFS CID。
- 购买流程：学员用 LENS 支付；记录购买与授权（mapping 课程ID -> buyer -> access）。
- 课程授权接口：前端/后端可查询授权状态；事件用于监听与索引。
- 费率：可设置平台抽成（如 5%），余款给讲师；提现到讲师钱包或资金路由器。

3) 收益与兑换合约（资金路由器）
- 讲师提现：将课程收入的 LENS 转换为 ETH，再换 USDT，质押到 Aave USDT 资产池获取 aUSDT。
- 路由流程（默认使用自建 Simple AMM，后续可切换 Uniswap V3）：
  - 第一步：LENS -> ETH（Simple AMM，x*y=k）。
  - 第二步：ETH -> USDT（Simple AMM，x*y=k）。
  - 第三步：USDT 供应到 Aave，获取 aUSDT（利息产生）。
- 取回：讲师可赎回 aUSDT 获得 USDT + 利息；可选回购 ETH/LENS。
- 安全：slippage 参数化、使用 permit 减少 approve 次数、可暂停 (Circuit Breaker)。

4) NFT 证书合约（可选高阶功能）
- 完成课程铸造 NFT 证书给学员。
- 证书包含课程名称、完成日期、讲师签名等元数据。

5) DAO 治理合约（可选高阶功能）
- LENS 持有者投票决定平台政策（抽成比例、新课程上线等）。
- 提案、投票、执行流程。

6) 访问控制与安全
- 使用 OpenZeppelin AccessControl/Ownable。
- 重入保护、检查代币精度、Aave/DEX 地址可更新配置。

### 3. 前端与用户流程
- **钱包连接模块**
  - wagmi + RainbowKit 集成（MetaMask/WalletConnect）；网络检测与切换提示；账户显示与余额查询。
  - UI 风格：Tailwind 主导样式，简洁/优美/炫酷，RainbowKit 主题自定义。
  
- **课程浏览与购买**
  - 课程列表：展示讲师发布的课程、价格（LENS）、评分、购买人数。
  - 课程详情：元数据（IPFS）、讲师信息、课程大纲。
  - 购买流程：选择课程 → 授权 LENS → 发送交易 → 确认授权 → 进入课程。
  
- **授权验证与内容访问**
  - 前端根据链上授权查询展示已购课程入口。
  - 后端结合签名鉴权提供课程资源链接（IPFS/Pinata）。
  
- **讲师中心**
  - 创建课程：填写元数据、上传资源到 IPFS、设置价格。
  - 销售统计：已售数量、总收入、待提现余额。
  - 提现管理：一键提现 LENS、发起 LENS→ETH→USDT→Aave 流程、查看 Aave 收益。
  - NFT 管理（可选）：给学员发放证书。
  
- **学员个人中心**
  - 账户管理：签名改名（EIP-191/712）、账户安全设置。
  - 已购课程：列表展示、进度追踪、课程资源访问。
  - 学习激励：LENS 余额、已获得 NFT 证书、DAO 投票权。
  
- **DAO 治理板块（可选）**
  - 提案列表与投票。
  - LENS 持有者参与决策。

### 4. 后端/服务组件
- **Nest.js API 服务**
  - 用户管理：注册、登录、昵称管理（签名验证后写 DB）。
  - 课程管理：元数据缓存、CID 映射、价格查询。
  - 交易查询：已购课程明细（链上校验 + 签名鉴权）、销售记录、收入统计。
  - 签名验证：EIP-191/712 签名校验；防重放机制。
  
- **数据库**
  - PostgreSQL：用户数据、课程元数据缓存、交易日志。
  - Redis：缓存热点数据、会话管理。
  
- **区块链索引**
  - The Graph（推荐）：自建 Subgraph 索引课程创建、购买、提现事件。
  - 初期可直接调用链上 RPC 查询（需优化性能）。
  
- **文件存储**
  - IPFS/Pinata：课程视频、讲义、资源存储。
  - 临时链接：后端根据授权生成短期访问链接。
  
- **部署与基础设施**
  - Cloudflare：全球 CDN 加速。
  - AWS/SAM：Serverless API 部署、自动扩展。
  - 监控告警：性能统计、交易异常告警。

### 5. 技术栈与集成

- **前端（Next.js）**
- React 18 + TypeScript
- Web3 库：wagmi + RainbowKit（MetaMask/WalletConnect），ethers、Viem（底层 RPC）
- UI 框架：Tailwind CSS，Material UI（按需）
- 状态管理：Zustand
- 数据获取：TanStack Query (React Query)
- 部署：Cloudflare Pages

**后端（Nest.js）**
- Node.js + TypeScript
- 框架：Nest.js（模块化、依赖注入）
- 数据库：PostgreSQL + Prisma ORM
- 缓存：Redis
- API：RESTful + GraphQL（可选）
- 区块链交互：ethers.js
- 部署：AWS ECS / Lambda + SAM

**智能合约（Solidity）**
- 版本：Solidity ^0.8.0
- 框架：Hardhat 开发测试，Foundry fork 测试
- 库：OpenZeppelin Contracts
- 部署工具：Hardhat Deploy 或 Foundry

**基础设施**
- 部署网络：Sepolia 测试网（学习）、主网（正式）
- 链上索引：The Graph Subgraph
- 文件存储：Pinata（IPFS 网关）
- 监控：Datadog / AWS CloudWatch

### 6. 测试计划
- **单元测试（Hardhat / Foundry）**
  - ERC20：mint、burn、transfer、permit 测试。
  - 课程市场：创建、购买、授权、费率分配逻辑。
  - 收益路由：LENS→ETH→USDT 兑换流程（默认 Simple AMM），Aave supply/withdraw（使用 fork）。
  - 安全：重入、访问控制、边界条件（价格为 0、重复购买、精度损失）。
  
- **集成测试（前端 Cypress）**
  - 完整购买流程：钱包连接 → 课程浏览 → 授权 → 购买 → 内容访问。
  - 讲师提现：查看收益 → 发起提现 → 确认交易 → 查看 Aave 余额。
  
- **本地测试**
  - Hardhat 本地节点 + 前端本地开发服务器。
  
- **测试网验证**
  - Sepolia 部署、端到端测试。
  - Aave 测试地址验证、The Graph Subgraph 查询验证。
  
- **性能与安全审计**
  - 合约代码审计（MythX / Slither）。
  - 前端性能优化（Lighthouse）。
  - 后端负载测试（k6 / Locust）。

### 7. 里程碑

**M0：项目初始化 & 环境配置**
- 创建 Hardhat 项目、Next.js 前端、Nest.js 后端项目结构。
- 配置钱包连接（MetaMask）、RPC 端点（Sepolia）。
- 初始化数据库、Pinata API、The Graph 配置。

**M1：合约基础 & 核心功能**
- 完成 LENS ERC20 合约：mint、transfer、permit。
- 完成课程市场合约：创建、购买、授权、费率逻辑。
- 单元测试覆盖 >80%。

- **M2：DeFi 集成**
- 实现 Simple AMM（LENS→ETH、ETH→USDT，x*y=k），预留切换 Uniswap V3 接口。
- 实现 Aave 供款合约集成（USDT 存入 Aave）。
- 讲师提现完整流程测试。

**M3：前端基础 M1**
- 钱包连接、课程列表/创建页面。
- 购买流程 UI、授权验证、内容展示。
- MetaMask 交易签名与确认。

**M4：前端高级 & 后端 M2**
- 讲师中心：销售统计、提现管理、Aave 收益查看。
- 学员中心：已购课程列表、签名改名、激励查看。
- 后端 API：签名验证、元数据服务、查询优化。

**M5：测试网与监控**
- 部署到 Sepolia 测试网。
- The Graph Subgraph 索引验证。
- 监控与告警配置。

**M6：高阶功能**
- NFT 证书发放。
- DAO 治理合约与投票系统。
- 完整的讲师知识库与 SEO 优化。

### 9. 快速开始

**环境要求**
- Node.js >= 18
- npm / pnpm
- Git

**本地开发**

1. 克隆项目
```bash
git clone <repo-url>
cd web3-university
```

2. 安装依赖
```bash
pnpm install
```

3. 前端样式与钱包依赖（frontend 目录）
```bash
pnpm add -D tailwindcss postcss autoprefixer
pnpm add wagmi @rainbow-me/rainbowkit viem ethers
pnpm dlx tailwindcss init -p
# Tailwind content 配置：./pages/**/*.{js,ts,jsx,tsx}, ./components/**/*.{js,ts,jsx,tsx}
# 全局样式：在 globals.css 引入 @tailwind base; @tailwind components; @tailwind utilities;
```

4. 配置环境变量
```bash
cp .env.example .env.local
# 编辑 .env.local，填入 Sepolia RPC、Pinata API 等配置
```

5. 启动本地 Hardhat 节点
```bash
pnpm hardhat node
```

6. 另一个终端部署合约
```bash
pnpm hardhat run scripts/deploy.ts --network localhost
```

7. 启动后端服务
```bash
cd backend
pnpm dev
```

8. 启动前端开发服务器
```bash
cd frontend
pnpm dev
```

9. 访问 http://localhost:3000 开始测试

**部署到 Sepolia**

```bash
pnpm hardhat run scripts/deploy.ts --network sepolia
```

### 10. 已确认关键点

- 平台抽成比例：平台 5%，讲师 95%。
- DeFi 路径：默认自建 Simple AMM（LENS→ETH→USDT），预留切换 Uniswap V3。
- Aave：使用 Sepolia Aave v3 USDT 测试地址。
- 高阶功能优先级：NFT 证书优先，其次 DAO 治理、知识库推广。
- 部署：后端 AWS + Cloudflare；前端 Cloudflare Pages（可选 Vercel）。
- 监控：暂不启用，可后续接入 Datadog / AWS CloudWatch。
